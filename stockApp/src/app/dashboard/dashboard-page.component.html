<p-toast></p-toast>

<section class="dashboard">
  <header class="dashboard__header">
    <div>
      <h1>Dashboard</h1>
      <p>Watch low-stock alerts and the latest stock movements at a glance.</p>
    </div>
    <div class="header-actions">
      <button
        pButton
        type="button"
        icon="pi pi-refresh"
        label="Refresh"
        class="p-button-text"
        (click)="loadSnapshot()"
        [disabled]="loading"
      ></button>
    </div>
  </header>

  <div class="dashboard__grid" [class.is-loading]="loading">
    <section class="card">
      <header class="card__header">
        <div>
          <h2>Low-Stock Products</h2>
          <p *ngIf="lowStock.length === 0">All products are above reorder levels.</p>
        </div>
      </header>

      <p-table
        [value]="lowStock"
        [loading]="loading"
        class="low-stock-table"
        *ngIf="lowStock.length > 0"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Product</th>
            <th class="numeric">Stock</th>
            <th class="numeric">Reorder Level</th>
            <th class="actions" *ngIf="canSuggest"></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>
              <div class="product-cell">
                <span class="sku">{{ item.sku }}</span>
                <span class="name">{{ item.name }}</span>
              </div>
            </td>
            <td class="numeric">{{ item.stock_on_hand }}</td>
            <td class="numeric">{{ item.reorder_level }}</td>
            <td class="badge-cell">
              <p-tag
                [severity]="statusSeverity(item)"
                [value]="item.stock_on_hand <= 0 ? 'Out' : 'Low'"
              ></p-tag>
              <button
                *ngIf="canSuggest"
                pButton
                type="button"
                icon="pi pi-bolt"
                class="p-button-rounded p-button-text"
                (click)="openSuggestion(item)"
                aria-label="Reorder suggestion"
              ></button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </section>

    <section class="card">
      <header class="card__header">
        <div>
          <h2>Recent Movements</h2>
          <p>Last 10 transactions</p>
        </div>
      </header>

      <p-table
        [value]="recentMovements"
        [loading]="loading"
        responsiveLayout="scroll"
        class="recent-table"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Date</th>
            <th>Product</th>
            <th>Type</th>
            <th class="numeric">Qty</th>
            <th>Reference</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-movement>
          <tr>
            <td>{{ movement.moved_at | date: 'dd MMM yyyy, HH:mm' }}</td>
            <td>
              <div class="product-cell">
                <span class="sku">{{ movement.product.sku }}</span>
                <span class="name">{{ movement.product.name }}</span>
              </div>
            </td>
            <td>
              <p-tag
                [severity]="movement.kind === 'IN' ? 'success' : 'danger'"
                [value]="movement.kind"
              ></p-tag>
            </td>
            <td class="numeric">{{ movement.quantity }}</td>
            <td>{{ movement.reference || '—' }}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="empty-state">No movements recorded yet.</td>
          </tr>
        </ng-template>
      </p-table>
    </section>
  </div>

  <p-dialog
    [(visible)]="suggestionDialogVisible"
    [modal]="true"
    [style]="{ width: '380px' }"
    [draggable]="false"
    [closable]="!suggestionLoading"
    (onHide)="closeSuggestionDialog()"
    [header]="suggestionTarget ? 'Reorder Suggestion — ' + suggestionTarget.sku : 'Reorder Suggestion'"
  >
    <div class="suggestion-dialog">
      <ng-container *ngIf="suggestionLoading">
        <p-progressSpinner styleClass="suggestion-spinner"></p-progressSpinner>
        <p class="loading-text">Calculating suggestion…</p>
      </ng-container>

      <ng-container *ngIf="!suggestionLoading">
        <p class="error-text" *ngIf="suggestionError">{{ suggestionError }}</p>

        <ng-container *ngIf="suggestionSummary && !suggestionError">
          <div class="suggestion-quantity">
            <span class="label">Suggested Quantity</span>
            <span class="value">{{ suggestionSummary.suggestion.quantity }}</span>
          </div>

          <div class="suggestion-basis">
            <h4>Basis</h4>
            <ul>
              <li *ngFor="let entry of suggestionBasisEntries()">
                <span class="basis-label">{{ entry.label }}</span>
                <span class="basis-value">{{ entry.value }}</span>
              </li>
            </ul>
          </div>
        </ng-container>
      </ng-container>
    </div>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Close"
        class="p-button-text"
        (click)="closeSuggestionDialog()"
        [disabled]="suggestionLoading"
      ></button>
    </ng-template>
  </p-dialog>
</section>
